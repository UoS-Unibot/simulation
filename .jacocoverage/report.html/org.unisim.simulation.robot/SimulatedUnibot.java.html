<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>SimulatedUnibot.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCoverage analysis of project &quot;UnibotSim&quot; (powered by JaCoCo from EclEmma)</a> &gt; <a href="index.source.html" class="el_package">org.unisim.simulation.robot</a> &gt; <span class="el_source">SimulatedUnibot.java</span></div><h1>SimulatedUnibot.java</h1><pre class="source lang-java linenums">package org.unisim.simulation.robot;

import java.awt.geom.Rectangle2D;
import org.apache.commons.math3.geometry.euclidean.twod.Vector2D;
import org.unisim.simulation.core.SimulationWorld;
import org.unisim.simulation.geometry.Shape2D;

/**
 * The SimulatedUnibot class implements IRobot with a simulated differential
 * drive model of the Unibot.
 *
 * @author Miles Bryant &lt;mb459 at sussex.ac.uk&gt;
 */
public class SimulatedUnibot implements IRobot {

<span class="nc" id="L16">    private float timeStepLength = 1f / 60f,</span>
            angularVelocity,forwardVelocity;
    private final IRobotController controller;
    private final RangeFinder rangeFinder;
    private final Vector2D size;
    private Shape2D shape;

    /**
     * Initialises a default SimulatedUnibot with initial position of 0,0,
     * initial heading of 0 radians and size of 0.6mx0.6m
     *
     * @param controller IRobotController used to control this robot.
     */
    public SimulatedUnibot(IRobotController controller,float maxRangeFinderRayLength) {
<span class="nc" id="L30">        this(controller, Vector2D.ZERO, new Vector2D(0.6, 0.6), 0,maxRangeFinderRayLength);</span>
<span class="nc" id="L31">    }</span>

    /**
     * Initialises a SimulatedUnibot specifying all parameters.
     *
     * @param controller IRobotController used to control this robot.
     * @param initialPosition initial world coordinates of the robot.
     * @param size Size of the robot in metres.
     * @param initialHeading Initial heading of the robot in radians.
     */
<span class="nc" id="L41">    public SimulatedUnibot(IRobotController controller, Vector2D initialPosition, Vector2D size, float initialHeading,float maxRangeFinderRayLength) {</span>
<span class="nc" id="L42">        shape = Shape2D.createRectangleFromCenter(initialPosition, size, initialHeading);</span>
<span class="nc" id="L43">        forwardVelocity = 0;</span>
<span class="nc" id="L44">        this.size = size;</span>
<span class="nc" id="L45">        this.controller = controller;</span>
<span class="nc" id="L46">        rangeFinder = new RangeFinder(getRangeFinderBase(), initialHeading, maxRangeFinderRayLength);</span>
<span class="nc" id="L47">    }</span>

    /**
     * Steps the SimulatedUnibot one time step, updating the controller with the
     * RobotInput (which would normally be the result of calling
     * calculateInput()) and setting the robot's forward and angular velocity to
     * the relevant output of the controller.
     *
     * @param input Simulated RobotInput.
     */
    @Override
    public void step(RobotInput input) {
<span class="nc" id="L59">        move(forwardVelocity*timeStepLength,angularVelocity*timeStepLength);</span>
<span class="nc" id="L60">        controller.step(input);</span>
<span class="nc" id="L61">        setVelocity(controller.getVelocity(), controller.getAngularVelocity((float) getSize().getX()));</span>
<span class="nc" id="L62">    }</span>
    
    public void move(float distance, float rotation) {
<span class="nc" id="L65">        shape.move(distance, rotation);</span>
<span class="nc" id="L66">        rangeFinder.setPosition(getRangeFinderBase());</span>
<span class="nc" id="L67">        rangeFinder.setAngle(getHeading());</span>
<span class="nc" id="L68">    }</span>
    
<span class="nc" id="L70">    private double lastRangeFind = 0;</span>
    
    public double getLastRangeFinderValue() {
<span class="nc" id="L73">        return lastRangeFind;</span>
    }

    /**
     * Simulates the range finder and sonar of the Unibot given the current
     * SimulationWorld - normally passed to this robot's step() function.
     *
     * @param world SimulationWorld.
     * @return Simulated RobotInput with calculated values.
     */
    public RobotInput calculateInput(SimulationWorld world) {
<span class="nc" id="L84">        lastRangeFind = rangeFinder.findRange(world.getObjects());</span>
<span class="nc" id="L85">        return new RobotInput(</span>
                (float)lastRangeFind,
                0,
                0,
                0,
                0
        );
    }

    /**
     * Gets a Java 2D geometry Rectangle2D object representing the robot's size
     * and current position. Currently only used in rendering.
     *
     * @return Rectangle2D object with current size and position.
     */
    private Rectangle2D getRectangle() {
<span class="nc" id="L101">        double halfW = getSize().getX() / 2,</span>
<span class="nc" id="L102">                halfH = getSize().getY() / 2;</span>
<span class="nc" id="L103">        Rectangle2D rect = new Rectangle2D.Double();</span>
<span class="nc" id="L104">        rect.setFrame(</span>
                getPosition().getX() - halfW,
                getPosition().getY() + halfH, 
                getSize().getX(), 
                -getSize().getY());
<span class="nc" id="L109">        return rect;</span>
    }
    

    /**
     * @return Where the base of the rangefinder is currently located.
     */
    public Vector2D getRangeFinderBase() {
<span class="nc" id="L117">        return shape.getLocalToWorldCoords(new Vector2D(size.getX() / 2,size.getY() / 2));</span>
    }

    /**
     * Processes a collision with an object in the world.
     * @param collidedObj Object that is colliding with this robot.
     */
    public void doCollision(Shape2D collidedObj) {
<span class="nc" id="L125">        setVelocity(0);</span>
<span class="nc" id="L126">    }</span>

    @Override
    public void setVelocity(float forwardVelocity) {
<span class="nc" id="L130">        this.forwardVelocity = forwardVelocity;</span>
<span class="nc" id="L131">    }</span>
    
    @Override
    public void setVelocity(float forwardVelocity, float angularVelocity) {
<span class="nc" id="L135">        setVelocity(forwardVelocity);</span>
<span class="nc" id="L136">        setAngularVelocity(angularVelocity);</span>
<span class="nc" id="L137">    }</span>

    @Override
    public void setAngularVelocity(float angularVelocity) {
<span class="nc" id="L141">        this.angularVelocity = angularVelocity;</span>
<span class="nc" id="L142">    }</span>

    public void setTimeStepLength(float lengthTimeStep) {
<span class="nc" id="L145">        this.timeStepLength = lengthTimeStep;</span>
<span class="nc" id="L146">    }</span>

    /**
     * @return the current IRobotController controlling this robot.
     */
    public IRobotController getController() {
<span class="nc" id="L152">        return controller;</span>
    }

    @Override
    public double getAngularVelocity() {
<span class="nc" id="L157">        return angularVelocity;</span>
    }

    @Override
    public Vector2D getSize() {
<span class="nc" id="L162">        return size;</span>
    }

    @Override
    public double getHeading() {
<span class="nc" id="L167">        return shape.getRotation();</span>
    }

    @Override
    public Vector2D getPosition() {
<span class="nc" id="L172">        return shape.getCenter();</span>
    }

    public Shape2D getShape() {
<span class="nc" id="L176">        return shape;</span>
    }

    public RangeFinder getRangeFinder() {
<span class="nc" id="L180">        return rangeFinder;</span>
    }

    

    @Override
    public double getVelocity() {
<span class="nc" id="L187">        return forwardVelocity;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.2.201409121644</span></div></body></html>